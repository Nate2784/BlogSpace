{% extends "blog/base.html" %}

{% block title %}{{ author.username }}'s Profile{% endblock %}

{% block content %}
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
    --secondary-gradient: linear-gradient(135deg, #06b6d4 0%, #3b82f6 50%, #8b5cf6 100%);
    --success-gradient: linear-gradient(135deg, #10b981, #059669);
    --warning-gradient: linear-gradient(135deg, #f59e0b, #d97706);
    --danger-gradient: linear-gradient(135deg, #ef4444, #dc2626);
  }

  /* Modern Profile Header */
  .profile-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 24px;
    padding: 4rem 2rem;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .profile-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
    pointer-events: none;
  }

  .profile-avatar {
    position: relative;
    display: inline-block;
    margin-bottom: 2rem;
  }

  .profile-avatar img {
    border-radius: 50%;
    width: 180px;
    height: 180px;
    object-fit: cover;
    border: 6px solid white;
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  .profile-avatar:hover img {
    transform: scale(1.05);
    box-shadow: 0 20px 45px rgba(99, 102, 241, 0.3);
  }

  .profile-name {
    font-family: 'Playfair Display', serif;
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .profile-username {
    font-size: 1.25rem;
    color: #64748b;
    font-weight: 500;
    margin-bottom: 1rem;
  }

  .profile-bio {
    font-size: 1.1rem;
    color: #475569;
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
  }

  /* Modern Posts Grid */
  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
  }

  /* Modern Post Card */
  .post-card {
    background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    display: flex;
    flex-direction: column;
  }

  .post-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 50px rgba(99, 102, 241, 0.2);
  }

  .post-image {
    position: relative;
    height: 200px;
    overflow: hidden;
  }

  .post-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease;
  }

  .post-card:hover .post-image img {
    transform: scale(1.05);
  }

  .post-image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.1) 100%);
  }

  .post-content {
    padding: 2rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .post-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    text-decoration: none;
    margin-bottom: 1rem;
    line-height: 1.3;
    transition: color 0.3s ease;
  }

  .post-title:hover {
    color: #6366f1;
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #64748b;
    font-size: 0.9rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .post-excerpt {
    color: #64748b;
    line-height: 1.6;
    margin-bottom: 1.5rem;
    flex-grow: 1;
    font-size: 0.95rem;
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    padding: 0.75rem 0;
  }

  .tag-badge {
    background: rgba(99, 102, 241, 0.08);
    color: #6366f1;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(99, 102, 241, 0.2);
    backdrop-filter: blur(10px);
    text-transform: capitalize;
    letter-spacing: 0.25px;
  }

  .tag-badge::before {
    content: '#';
    margin-right: 0.25rem;
    opacity: 0.7;
    font-weight: 600;
  }

  .tag-badge:hover {
    background: rgba(99, 102, 241, 0.15);
    border-color: rgba(99, 102, 241, 0.4);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    color: #4f46e5;
  }

  /* Elegant color variations */
  .tag-badge:nth-child(odd) {
    background: rgba(139, 92, 246, 0.08);
    color: #8b5cf6;
    border-color: rgba(139, 92, 246, 0.2);
  }

  .tag-badge:nth-child(odd):hover {
    background: rgba(139, 92, 246, 0.15);
    border-color: rgba(139, 92, 246, 0.4);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
    color: #7c3aed;
  }

  .tag-badge:nth-child(3n) {
    background: rgba(6, 182, 212, 0.08);
    color: #06b6d4;
    border-color: rgba(6, 182, 212, 0.2);
  }

  .tag-badge:nth-child(3n):hover {
    background: rgba(6, 182, 212, 0.15);
    border-color: rgba(6, 182, 212, 0.4);
    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.2);
    color: #0891b2;
  }

  .tag-badge:nth-child(5n) {
    background: rgba(16, 185, 129, 0.08);
    color: #10b981;
    border-color: rgba(16, 185, 129, 0.2);
  }

  .tag-badge:nth-child(5n):hover {
    background: rgba(16, 185, 129, 0.15);
    border-color: rgba(16, 185, 129, 0.4);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    color: #059669;
  }

  .post-actions {
    margin-top: auto;
  }

  .post-btn {
    width: 100%;
    background: var(--primary-gradient);
    color: white;
    border: none;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .post-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.6s ease;
  }

  .post-btn:hover {
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 12px 30px rgba(99, 102, 241, 0.4);
  }

  .post-btn:hover::before {
    left: 100%;
  }

  .author-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
  }

  .author-actions .btn {
    flex: 1;
  }

  /* Modern Tabs */
  .nav-tabs {
    border: none;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 0.5rem;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }

  .nav-tabs .nav-link {
    border: none;
    border-radius: 12px;
    padding: 1rem 2rem;
    font-weight: 600;
    color: #64748b;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .nav-tabs .nav-link.active {
    background: var(--primary-gradient);
    color: white;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
  }

  .nav-tabs .nav-link:hover:not(.active) {
    background: rgba(99, 102, 241, 0.1);
    color: #6366f1;
  }

  /* Load More Button */
  .load-more-btn {
    background: var(--primary-gradient);
    color: white;
    border: none;
    padding: 1.25rem 3rem;
    border-radius: 50px;
    font-weight: 700;
    font-size: 1.1rem;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .load-more-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.6s ease;
  }

  .load-more-btn:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 15px 35px rgba(99, 102, 241, 0.4);
  }

  .load-more-btn:hover::before {
    left: 100%;
  }

  .load-more-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .load-more-btn .btn-count {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    margin-left: 0.5rem;
  }

  /* Loading Animation */
  .loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #64748b;
  }

  .empty-state-icon {
    font-size: 4rem;
    margin-bottom: 2rem;
    opacity: 0.5;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .empty-state h3 {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    margin-bottom: 1rem;
    color: #1e293b;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .profile-header {
      padding: 3rem 1.5rem;
    }

    .profile-avatar img {
      width: 150px;
      height: 150px;
    }

    .profile-name {
      font-size: 2rem;
    }

    .posts-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .post-content {
      padding: 1.5rem;
    }

    .nav-tabs .nav-link {
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
    }
  }

  @media (max-width: 480px) {
    .profile-header {
      padding: 2rem 1rem;
    }

    .profile-avatar img {
      width: 120px;
      height: 120px;
    }

    .profile-name {
      font-size: 1.75rem;
    }

    .post-content {
      padding: 1.25rem;
    }
  }

  /* Go to Top Button */
  .go-to-top {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 60px;
    height: 60px;
    background: var(--primary-gradient);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
  }

  .go-to-top.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .go-to-top:hover {
    transform: translateY(-4px) scale(1.1);
    box-shadow: 0 15px 35px rgba(99, 102, 241, 0.4);
  }

  .go-to-top:active {
    transform: translateY(-2px) scale(1.05);
  }

  @media (max-width: 768px) {
    .go-to-top {
      width: 50px;
      height: 50px;
      bottom: 1.5rem;
      right: 1.5rem;
      font-size: 1.25rem;
    }
  }
</style>

<div class="container my-5">

  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <a href="javascript:history.back()" class="btn btn-outline-secondary rounded-pill px-4 fw-semibold">
      ← Go Back
    </a>

    {% if user == author %}
    <div class="d-flex gap-2 flex-wrap">
      <a href="{% url 'edit_profile' %}" class="btn btn-warning rounded-pill px-4 fw-semibold">
        ✏️ Edit Profile
      </a>
      <a href="{% url 'change_password' %}" class="btn btn-danger rounded-pill px-4 fw-semibold">
        🔒 Change Password
      </a>
    </div>
    {% endif %}
  </div>

  <!-- Modern Profile Header -->
  <section class="profile-header mb-5">
    <div class="profile-avatar">
      {% if author.profile.profile_picture %}
        <img src="{{ author.profile.profile_picture.url }}" alt="{{ author.username }} profile picture">
      {% else %}
        <div class="d-flex align-items-center justify-content-center rounded-circle" style="width: 180px; height: 180px; background: var(--primary-gradient); color: white; font-size: 4rem; font-weight: bold; border: 6px solid white; box-shadow: 0 15px 35px rgba(0,0,0,0.2);">
          {{ author.username|first|upper }}
        </div>
      {% endif %}
    </div>

    <h1 class="profile-name">
      {% if author.first_name or author.last_name %}
        {{ author.first_name }} {{ author.last_name }}
      {% else %}
        {{ author.username }}
      {% endif %}
    </h1>
    <p class="profile-username">@{{ author.username }}</p>

    {% if author.profile.bio %}
      <p class="profile-bio">{{ author.profile.bio }}</p>
    {% else %}
      <p class="profile-bio text-muted">This user hasn’t added a bio yet.</p>
    {% endif %}

    <!-- Profile Stats -->
    <div class="row mt-4 justify-content-center">
      <div class="col-auto">
        <div class="text-center">
          <div class="h4 mb-0 fw-bold text-primary">{{ total_own_posts }}</div>
          <small class="text-muted">Posts</small>
        </div>
      </div>
      <div class="col-auto">
        <div class="text-center">
          <div class="h4 mb-0 fw-bold text-success">{{ total_tagged_posts }}</div>
          <small class="text-muted">Tagged</small>
        </div>
      </div>
    </div>
  </section>

  <!-- Modern Tabs for Personal & Tagged Blogs -->
  <ul class="nav nav-tabs justify-content-center mb-5" id="blogsTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active fw-semibold" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal" type="button" role="tab" aria-controls="personal" aria-selected="true">
        <i class="fas fa-pen-fancy me-2"></i>Personal Posts
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link fw-semibold" id="tagged-tab" data-bs-toggle="tab" data-bs-target="#tagged" type="button" role="tab" aria-controls="tagged" aria-selected="false">
        <i class="fas fa-tags me-2"></i>Tagged Posts
      </button>
    </li>
  </ul>

  <div class="tab-content" id="blogsTabContent">
    <!-- Personal Posts Tab Pane -->
    <div class="tab-pane fade show active" id="personal" role="tabpanel" aria-labelledby="personal-tab">
      {% if own_posts %}
        <div class="posts-grid" id="personal-posts-grid">
          {% for post in own_posts %}
            <article class="post-card">
              <div class="post-image">
                {% if post.image %}
                  <img src="{{ post.image.url }}" alt="{{ post.title }}" loading="lazy">
                {% else %}
                  <div class="d-flex align-items-center justify-content-center bg-light h-100">
                    <i class="fas fa-image text-muted" style="font-size: 3rem;"></i>
                  </div>
                {% endif %}
                <div class="post-image-overlay"></div>
              </div>

              <div class="post-content">
                <a href="{% url 'post_detail' post.id %}" class="post-title">
                  {{ post.title }}
                </a>

                <div class="post-meta">
                  <i class="fas fa-calendar-alt me-2"></i>
                  {{ post.created_at|date:"M j, Y" }}
                  <span class="mx-2">•</span>
                  <i class="fas fa-eye me-1"></i>
                  {{ post.views.count }} views
                  <span class="mx-2">•</span>
                  <i class="fas fa-heart me-1"></i>
                  {{ post.total_likes }} likes
                </div>

                <p class="post-excerpt">{{ post.content|truncatewords:20 }}</p>

                {% if post.tags.all %}
                  <div class="post-tags">
                    {% for tag in post.tags.all %}
                      <a href="{% url 'posts_page' %}?tag={{ tag.name }}" class="tag-badge">
                        {{ tag.name }}
                      </a>
                    {% endfor %}
                  </div>
                {% endif %}

                <div class="post-actions">
                  <a href="{% url 'post_detail' post.id %}" class="post-btn">
                    <i class="fas fa-book-open"></i>
                    <span>Read Story</span>
                    <i class="fas fa-arrow-right"></i>
                  </a>

                  {% if user == post.author %}
                    <div class="author-actions mt-2">
                      <a href="{% url 'edit_post' post.id %}" class="btn btn-outline-primary btn-sm me-2">
                        <i class="fas fa-edit me-1"></i>Edit
                      </a>
                      <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete({{ post.id }})">
                        <i class="fas fa-trash me-1"></i>Delete
                      </button>
                    </div>
                  {% endif %}
                </div>
              </div>
            </article>
          {% endfor %}
        </div>

        <!-- Load More Button for Personal Posts -->
        {% if has_more_own %}
          <div class="text-center mt-5" id="load-more-personal-container">
            <button id="load-more-personal-btn" class="load-more-btn" data-offset="6" data-type="own">
              <i class="fas fa-plus-circle me-2"></i>
              <span class="btn-text">Load More Posts</span>
              <span class="btn-count">({{ total_own_posts|add:"-6" }} remaining)</span>
            </button>
          </div>
        {% endif %}
      {% else %}
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-pen-fancy"></i>
          </div>
          <h3>No Personal Posts Yet</h3>
          <p class="mb-4">{% if user == author %}You haven't{% else %}This user hasn't{% endif %} written any posts yet.</p>
          {% if user == author %}
            <a href="{% url 'create_post' %}" class="btn btn-primary btn-lg">
              <i class="fas fa-plus me-2"></i>Write Your First Post
            </a>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- Tagged Posts Tab Pane -->
    <div class="tab-pane fade" id="tagged" role="tabpanel" aria-labelledby="tagged-tab">
      {% if tagged_posts %}
        <div class="posts-grid" id="tagged-posts-grid">
          {% for post in tagged_posts %}
            <article class="post-card">
              <div class="post-image">
                {% if post.image %}
                  <img src="{{ post.image.url }}" alt="{{ post.title }}" loading="lazy">
                {% else %}
                  <div class="d-flex align-items-center justify-content-center bg-light h-100">
                    <i class="fas fa-image text-muted" style="font-size: 3rem;"></i>
                  </div>
                {% endif %}
                <div class="post-image-overlay"></div>
              </div>

              <div class="post-content">
                <a href="{% url 'post_detail' post.id %}" class="post-title">
                  {{ post.title }}
                </a>

                <div class="post-meta">
                  <i class="fas fa-user-circle me-2"></i>
                  By {{ post.author.username }}
                  <span class="mx-2">•</span>
                  <i class="fas fa-calendar-alt me-1"></i>
                  {{ post.created_at|date:"M j, Y" }}
                  <span class="mx-2">•</span>
                  <i class="fas fa-eye me-1"></i>
                  {{ post.views.count }} views
                </div>

                <p class="post-excerpt">{{ post.content|truncatewords:20 }}</p>

                {% if post.tags.all %}
                  <div class="post-tags">
                    {% for tag in post.tags.all %}
                      <a href="{% url 'posts_page' %}?tag={{ tag.name }}" class="tag-badge">
                        {{ tag.name }}
                      </a>
                    {% endfor %}
                  </div>
                {% endif %}

                <div class="post-actions">
                  <a href="{% url 'post_detail' post.id %}" class="post-btn">
                    <i class="fas fa-book-open"></i>
                    <span>Read Story</span>
                    <i class="fas fa-arrow-right"></i>
                  </a>
                </div>
              </div>
            </article>
          {% endfor %}
        </div>

        <!-- Load More Button for Tagged Posts -->
        {% if has_more_tagged %}
          <div class="text-center mt-5" id="load-more-tagged-container">
            <button id="load-more-tagged-btn" class="load-more-btn" data-offset="6" data-type="tagged">
              <i class="fas fa-plus-circle me-2"></i>
              <span class="btn-text">Load More Posts</span>
              <span class="btn-count">({{ total_tagged_posts|add:"-6" }} remaining)</span>
            </button>
          </div>
        {% endif %}
      {% else %}
        <div class="empty-state">
          <div class="empty-state-icon">
            <i class="fas fa-tags"></i>
          </div>
          <h3>No Tagged Posts Yet</h3>
          <p class="mb-4">{% if user == author %}You haven't{% else %}This user hasn't{% endif %} been tagged in any posts yet.</p>
        </div>
      {% endif %}
    </div>
  </div>

</div>

<!-- Go to Top Button -->
<button class="go-to-top" id="go-to-top" title="Go to top">
  <i class="fas fa-chevron-up"></i>
</button>

<script>
// Go to Top functionality
document.addEventListener('DOMContentLoaded', function() {
    const goToTopBtn = document.getElementById('go-to-top');

    // Handle scroll events for go to top button
    window.addEventListener('scroll', function() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        // Show/hide go to top button
        if (scrollTop > 500) {
            goToTopBtn.classList.add('show');
        } else {
            goToTopBtn.classList.remove('show');
        }
    });

    // Go to top functionality
    goToTopBtn.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
});
document.addEventListener('DOMContentLoaded', function() {
    // Handle Load More for Personal Posts
    const loadMorePersonalBtn = document.getElementById('load-more-personal-btn');
    const personalPostsGrid = document.getElementById('personal-posts-grid');
    const loadMorePersonalContainer = document.getElementById('load-more-personal-container');

    if (loadMorePersonalBtn) {
        loadMorePersonalBtn.addEventListener('click', function() {
            loadMorePosts(this, personalPostsGrid, loadMorePersonalContainer, 'own');
        });
    }

    // Handle Load More for Tagged Posts
    const loadMoreTaggedBtn = document.getElementById('load-more-tagged-btn');
    const taggedPostsGrid = document.getElementById('tagged-posts-grid');
    const loadMoreTaggedContainer = document.getElementById('load-more-tagged-container');

    if (loadMoreTaggedBtn) {
        loadMoreTaggedBtn.addEventListener('click', function() {
            loadMorePosts(this, taggedPostsGrid, loadMoreTaggedContainer, 'tagged');
        });
    }

    function loadMorePosts(button, postsGrid, container, postType) {
        const offset = parseInt(button.dataset.offset);
        const type = button.dataset.type;

        console.log('Loading more posts:', { offset, type, postType });

        // Show loading state
        const originalContent = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `
            <div class="loading-spinner"></div>
            <span>Loading Posts...</span>
        `;

        // Build URL
        const url = new URL('{% url "load_more_author_posts" author.username %}', window.location.origin);
        url.searchParams.set('offset', offset);
        url.searchParams.set('type', type);

        console.log('Request URL:', url.toString());

        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            if (data.posts_html) {
                // Create temporary container to parse HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = data.posts_html;

                // Add fade-in animation to new posts
                const newPosts = tempDiv.querySelectorAll('.post-card');
                newPosts.forEach((post, index) => {
                    post.classList.add('fade-in');
                    post.style.animationDelay = `${index * 0.1}s`;
                });

                // Append new posts to grid
                while (tempDiv.firstChild) {
                    postsGrid.appendChild(tempDiv.firstChild);
                }

                // Update button state
                if (data.has_more) {
                    button.dataset.offset = data.new_offset;
                    button.disabled = false;
                    button.innerHTML = originalContent;

                    // Update remaining count
                    const btnCount = button.querySelector('.btn-count');
                    if (btnCount) {
                        const remaining = parseInt(btnCount.textContent.match(/\d+/)[0]) - 6;
                        btnCount.textContent = `(${Math.max(0, remaining)} remaining)`;
                    }
                } else {
                    // No more posts, hide button
                    container.style.display = 'none';
                }
            }
        })
        .catch(error => {
            console.error('Error loading more posts:', error);
            button.disabled = false;
            button.innerHTML = originalContent;

            // Show error message
            const errorMsg = document.createElement('div');
            errorMsg.className = 'alert alert-danger mt-3';
            errorMsg.textContent = 'Failed to load more posts. Please try again.';
            container.appendChild(errorMsg);

            // Remove error message after 5 seconds
            setTimeout(() => {
                if (errorMsg.parentNode) {
                    errorMsg.parentNode.removeChild(errorMsg);
                }
            }, 5000);
        });
    }

    // Delete confirmation function
    window.confirmDelete = function(postId) {
        if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
            window.location.href = `/post/${postId}/delete/`;
        }
    };
});
</script>
{% endblock %}
